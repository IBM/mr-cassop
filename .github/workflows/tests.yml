name: Tests

on:
  pull_request:
  release:
    types:
      - created
  push:
    branches:
      - main

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@e868220d9fd3b523f1a8fcfb69749e8c7521ba14 # v2.3.0
        with:
          version: v1.33.0
          args: --timeout=2m
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go with latest minor version 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.15
      - name: Setup Kubebuilder assets
        run: |
          curl -sSLo envtest-bins.tar.gz "https://storage.googleapis.com/kubebuilder-tools/kubebuilder-tools-1.21.2-linux-amd64.tar.gz"
          mkdir -p /tmp/kubebuilder
          tar -C /tmp/kubebuilder/ --strip-components=1 -zvxf envtest-bins.tar.gz
          rm envtest-bins.tar.gz;
          echo "KUBEBUILDER_ASSETS=/tmp/kubebuilder/bin" >> $GITHUB_ENV
      - uses: actions/checkout@v2
      - name: Get dependencies
        run: go mod download
      - name: Run unit tests
        run: make unit-tests
      - name: Run integration tests
        run: make integration-tests
      - name: Get tests coverage
        run: |
          go tool cover -func=unit.out | tail -n1 | awk "{print \"Unit tests coverage: \" \$3}"
          go tool cover -func=integration.out | tail -n1 | awk "{print \"Integration tests coverage: \" \$3}"
