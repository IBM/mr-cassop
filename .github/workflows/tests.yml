name: Tests

on:
  pull_request:
  release:
    types:
      - created
  push:
    branches:
      - main

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2.3.0
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@e868220d9fd3b523f1a8fcfb69749e8c7521ba14 # v2.3.0
        with:
          version: v1.33.0
          args: --timeout=2m
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go with latest minor version 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.15
      - name: Setup Kubebuilder assets
        run: |
          wget -O kubebuilder.tgz https://go.kubebuilder.io/dl/2.3.1/linux/amd64;
          tar -C /tmp/ -xzf kubebuilder.tgz;
          rm kubebuilder.tgz;
          echo "KUBEBUILDER_ASSETS=/tmp/kubebuilder_2.3.1_linux_amd64/bin" >> $GITHUB_ENV
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Get dependencies
        run: go mod download
      - name: Run tests
        run: go test ./controllers/... ./tests/integration -coverprofile=cover.out -v -coverpkg=./...
      - name: Get current test coverage
        run: |
          go tool cover -func=cover.out | tail 1 | awk "{print \"Total coverage: \" \$3}"
