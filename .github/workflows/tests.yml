name: Tests

on: push

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2.3.0
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v2
        with:
          version: v1.29
          args: --timeout=2m
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.15
        id: go
      - name: Setup Kubebuilder assets
        run: |
          wget -O kubebuilder.tgz https://go.kubebuilder.io/dl/2.3.1/linux/amd64;
          tar -C /tmp/ -xzf kubebuilder.tgz;
          rm kubebuilder.tgz;
          echo "KUBEBUILDER_ASSETS=/tmp/kubebuilder_2.3.1_linux_amd64/bin" >> $GITHUB_ENV
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Get dependencies
        run: go mod download
      - name: Run tests
        run: go test ./controllers/... ./tests/integration -coverprofile=cover.out -v -coverpkg=./...
      - name: Get current test coverage
        run: |
          go tool cover -func=cover.out | tail 1 | awk "{print \"Total coverage: \" \$3}"